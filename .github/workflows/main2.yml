# File: .github/workflows/workflow.yml

name: Run Azure Login with Service Principal
on: [push]

permissions:
  id-token: write
  contents: read
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      KV_NAME: 'kv-f9m-dev'
    steps:
      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          enable-AzPSSession: true

      - name: Azure CLI script
        uses: azure/cli@v2
        with:
          azcliversion: latest
          inlineScript: |
            az account show

      - name: Azure PowerShell script
        uses: azure/powershell@v2
        with:
          azPSVersion: "latest"
          inlineScript: |
            Get-AzContext
      
      - name: Get secret from Azure Key Vault
        id: getsecret
        run: |
          echo "SECRET_VALUE=$(az keyvault secret show -n test-secret --vault-name ${{ env.KV_NAME }} --query value -o tsv)" >> $GITHUB_ENV

      - name: Use the secret
        run: |
          echo "The secret is ${{ env.SECRET_VALUE }}"
          echo "The secret is ${{ steps.getsecret.outputs.SECRET_VALUE }}"
          echo "The key vault name is ${{ vars.KV_NAME }}"

            
